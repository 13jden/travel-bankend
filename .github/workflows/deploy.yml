name: Deploy to Server

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches: [master, main, develop]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    strategy:
      matrix:
        include:
          - branch: develop
            environment: staging
            server_host: ${{ secrets.STAGING_HOST }}
            server_user: ${{ secrets.STAGING_USER }}
            server_key: ${{ secrets.STAGING_SSH_KEY }}
          - branch: master
            environment: production
            server_host: ${{ secrets.PRODUCTION_HOST }}
            server_user: ${{ secrets.PRODUCTION_USER }}
            server_key: ${{ secrets.PRODUCTION_SSH_KEY }}
          - branch: main
            environment: production
            server_host: ${{ secrets.PRODUCTION_HOST }}
            server_user: ${{ secrets.PRODUCTION_USER }}
            server_key: ${{ secrets.PRODUCTION_SSH_KEY }}
    
    environment: ${{ matrix.environment }}
    
    steps:
    - name: Checkout deployment scripts
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          deploy/
        sparse-checkout-cone-mode: false
        
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ matrix.server_key }}
        
    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ matrix.server_host }} >> ~/.ssh/known_hosts
        
    - name: Deploy to server
      run: |
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        ssh ${{ matrix.server_user }}@${{ matrix.server_host }} "mkdir -p /opt/travel-spring"
        
        # ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶
        scp -r deploy/* ${{ matrix.server_user }}@${{ matrix.server_host }}:/opt/travel-spring/
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        ssh ${{ matrix.server_user }}@${{ matrix.server_host }} "
          cd /opt/travel-spring
          
          # åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if [ ! -f .env ]; then
            cp env.example .env
            sed -i 's/your-username/${{ github.repository_owner }}/g' .env
          fi
          
          # ç»™éƒ¨ç½²è„šæœ¬æ‰§è¡Œæƒé™
          chmod +x deploy.sh
          
          # æ‰§è¡Œéƒ¨ç½²
          ./deploy.sh ${{ matrix.environment }}
        "
        
    - name: Verify deployment
      run: |
        ssh ${{ matrix.server_user }}@${{ matrix.server_host }} "
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 30
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          if curl -f http://localhost:8080/actuator/health; then
            echo 'âœ… éƒ¨ç½²æˆåŠŸï¼æœåŠ¡æ­£å¸¸è¿è¡Œ'
          else
            echo 'âŒ éƒ¨ç½²å¤±è´¥ï¼æœåŠ¡æœªæ­£å¸¸å¯åŠ¨'
            docker-compose -f /opt/travel-spring/docker-compose.yml logs --tail=50
            exit 1
          fi
        "
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ ${{ matrix.environment }} ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
        else
          echo "ğŸ’¥ ${{ matrix.environment }} ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼"
        fi 